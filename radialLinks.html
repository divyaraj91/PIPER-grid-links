<!DOCTYPE html>
<meta charset = "utf-8">
<head>
<title> cartTopolar </title>
</head>
<body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script>

var width = 500;
var height = 500;

var svg = d3.select("body")
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .append("g")
            .attr("transform", "translate(" + width/2 + ", " + height/2 + ")");

d3.select("svg").append("line")
                .attr("x1", 0)
                .attr("y1", height/2)
                .attr("x2", width)
                .attr("y2", height/2)
                .attr("stroke", "red")
                .attr("stroke-width", 1);

d3.select("svg").append("line")
                .attr("x1", width/2)
                .attr("y1", 0)
                .attr("x2", width/2)
                .attr("y2", height)
                .attr("stroke", "red")
                .attr("stroke-width", 1);

//var data = [{"r": 1, "c": 1},
//            {"r": 1, "c": 2},
//            {"r": 1, "c": 3},
//            {"r": 1, "c": 4},
//            {"r": 1, "c": 5},
//            {"r": 1, "c": 6},
//            {"r": 1, "c": 7},
//            {"r": 1, "c": 8},
//            {"r": 1, "c": 9},
//            {"r": 1, "c": 10},
//            {"r": 2, "c": 1},
//            {"r": 2, "c": 2},
//            {"r": 2, "c": 3},
//            {"r": 2, "c": 4},
//            {"r": 2, "c": 5},
//            {"r": 2, "c": 6},
//            {"r": 2, "c": 7},
//            {"r": 2, "c": 8},
//            {"r": 2, "c": 9},
//            {"r": 2, "c": 10},
//            {"r": 3, "c": 1},
//            {"r": 3, "c": 2},
//            {"r": 3, "c": 3},
//            {"r": 3, "c": 4},
//            {"r": 3, "c": 5},
//            {"r": 3, "c": 6},
//            {"r": 3, "c": 7},
//            {"r": 3, "c": 8},
//            {"r": 3, "c": 9},
//            {"r": 3, "c": 10},
//            {"r": 4, "c": 1},
//            {"r": 4, "c": 2},
//            {"r": 4, "c": 3},
//            {"r": 4, "c": 4},
//            {"r": 4, "c": 5},
//            {"r": 4, "c": 6},
//            {"r": 4, "c": 7},
//            {"r": 4, "c": 8},
//            {"r": 4, "c": 9},
//            {"r": 4, "c": 10}
//            ];

var data = new Map();
data.set("n1", {"group":1, "row": 0, "col": 0});
data.set("n2", {"group":1, "row": 0, "col": 1});
data.set("n3", {"group":1, "row": 0, "col": 2});
data.set("n4", {"group":1, "row": 0, "col": 3});
data.set("n5", {"group":1, "row": 0, "col": 4});
data.set("n6", {"group":1, "row": 0, "col": 5});
data.set("n7", {"group":1, "row": 0, "col": 6});
data.set("n8", {"group":1, "row": 0, "col": 7});
data.set("n9", {"group":1, "row": 0, "col": 8});
data.set("n10", {"group":1, "row": 0, "col": 9});
data.set("n11", {"group":1, "row": 0, "col": 10});
data.set("n12", {"group":1, "row": 0, "col": 11});
data.set("n13", {"group":1, "row": 0, "col": 12});
data.set("n14", {"group":1, "row": 0, "col": 13});
data.set("n15", {"group":1, "row": 0, "col": 14});
data.set("n16", {"group":1, "row": 0, "col": 15});

data.set("n17", {"group":1, "row": 1, "col": 0});
data.set("n18", {"group":1, "row": 1, "col": 1});
data.set("n19", {"group":1, "row": 1, "col": 2});
data.set("n20", {"group":1, "row": 1, "col": 3});
data.set("n21", {"group":1, "row": 1, "col": 4});
data.set("n22", {"group":1, "row": 1, "col": 5});
data.set("n23", {"group":1, "row": 1, "col": 6});
data.set("n24", {"group":1, "row": 1, "col": 7});
data.set("n25", {"group":1, "row": 1, "col": 8});
data.set("n26", {"group":1, "row": 1, "col": 9});
data.set("n27", {"group":1, "row": 1, "col": 10});
data.set("n28", {"group":1, "row": 1, "col": 11});
data.set("n29", {"group":1, "row": 1, "col": 12});
data.set("n30", {"group":1, "row": 1, "col": 13});
data.set("n31", {"group":1, "row": 1, "col": 14});
data.set("n32", {"group":1, "row": 1, "col": 15});

data.set("n33", {"group":1, "row": 2, "col": 0});
data.set("n34", {"group":1, "row": 2, "col": 1});
data.set("n35", {"group":1, "row": 2, "col": 2});
data.set("n36", {"group":1, "row": 2, "col": 3});
data.set("n37", {"group":1, "row": 2, "col": 4});
data.set("n38", {"group":1, "row": 2, "col": 5});
data.set("n39", {"group":1, "row": 2, "col": 6});
data.set("n40", {"group":1, "row": 2, "col": 7});
data.set("n41", {"group":1, "row": 2, "col": 8});
data.set("n42", {"group":1, "row": 2, "col": 9});
data.set("n43", {"group":1, "row": 2, "col": 10});
data.set("n44", {"group":1, "row": 2, "col": 11});
data.set("n45", {"group":1, "row": 2, "col": 12});
data.set("n46", {"group":1, "row": 2, "col": 13});
data.set("n47", {"group":1, "row": 2, "col": 14});
data.set("n48", {"group":1, "row": 2, "col": 15});

data.set("n49", {"group":1, "row": 3, "col": 0});
data.set("n50", {"group":1, "row": 3, "col": 1});
data.set("n51", {"group":1, "row": 3, "col": 2});
data.set("n52", {"group":1, "row": 3, "col": 3});
data.set("n53", {"group":1, "row": 3, "col": 4});
data.set("n54", {"group":1, "row": 3, "col": 5});
data.set("n55", {"group":1, "row": 3, "col": 6});
data.set("n56", {"group":1, "row": 3, "col": 7});
data.set("n57", {"group":1, "row": 3, "col": 8});
data.set("n58", {"group":1, "row": 3, "col": 9});
data.set("n59", {"group":1, "row": 3, "col": 10});
data.set("n60", {"group":1, "row": 3, "col": 11});
data.set("n61", {"group":1, "row": 3, "col": 12});
data.set("n62", {"group":1, "row": 3, "col": 13});
data.set("n63", {"group":1, "row": 3, "col": 14});
data.set("n64", {"group":1, "row": 3, "col": 15});

data.set("n65", {"group":1, "row": 4, "col": 0});
data.set("n66", {"group":1, "row": 4, "col": 1});
data.set("n67", {"group":1, "row": 4, "col": 2});
data.set("n68", {"group":1, "row": 4, "col": 3});
data.set("n69", {"group":1, "row": 4, "col": 4});
data.set("n70", {"group":1, "row": 4, "col": 5});
data.set("n71", {"group":1, "row": 4, "col": 6});
data.set("n72", {"group":1, "row": 4, "col": 7});
data.set("n73", {"group":1, "row": 4, "col": 8});
data.set("n74", {"group":1, "row": 4, "col": 9});
data.set("n75", {"group":1, "row": 4, "col": 10});
data.set("n76", {"group":1, "row": 4, "col": 11});
data.set("n77", {"group":1, "row": 4, "col": 12});
data.set("n78", {"group":1, "row": 4, "col": 13});
data.set("n79", {"group":1, "row": 4, "col": 14});
data.set("n80", {"group":1, "row": 4, "col": 15});

data.set("n81", {"group":1, "row": 5, "col": 0});
data.set("n82", {"group":1, "row": 5, "col": 1});
data.set("n83", {"group":1, "row": 5, "col": 2});
data.set("n84", {"group":1, "row": 5, "col": 3});
data.set("n85", {"group":1, "row": 5, "col": 4});
data.set("n86", {"group":1, "row": 5, "col": 5});
data.set("n87", {"group":1, "row": 5, "col": 6});
data.set("n88", {"group":1, "row": 5, "col": 7});
data.set("n89", {"group":1, "row": 5, "col": 8});
data.set("n90", {"group":1, "row": 5, "col": 9});
data.set("n91", {"group":1, "row": 5, "col": 10});
data.set("n92", {"group":1, "row": 5, "col": 11});
data.set("n93", {"group":1, "row": 5, "col": 12});
data.set("n94", {"group":1, "row": 5, "col": 13});
data.set("n95", {"group":1, "row": 5, "col": 14});
data.set("n96", {"group":1, "row": 5, "col": 15});

link = [{"s": "n1", "t": "n2"},
    {"s": "n3", "t": "n4"},
    {"s": "n3", "t": "n19"},
    {"s": "n3", "t": "n35"},
    {"s": "n3", "t": "n35"},
    {"s": "n4", "t": "n84"},
    {"s": "n10", "t": "n12"},
    {"s": "n34", "t": "n36"},
    {"s": "n39", "t": "n47"},
    {"s": "n51", "t": "n83"},
    {"s": "n59", "t": "n91"},
    {"s": "n64", "t": "n96"},
    {"s": "n66", "t": "n82"},
    {"s": "n81", "t": "n90"},
    {"s": "n81", "t": "n83"},
    {"s": "n81", "t": "n85"},
    {"s": "n81", "t": "n86"},];

var dataCount = data.length;
var dataNodes = [];
var dataNodesMap = new Map();
var linkConn = [];
var linkArc = [];
var linkLine = [];

var groupMargin = 5;

var startAngle = 0 ;
var endAngle = 180;
var innerRadius = 150;
var outerRadius = 200;

data.forEach(function(value, key){
    layout(value, key, startAngle, endAngle, innerRadius, outerRadius);
});

link.forEach(function(d){
    linkLayout(d);
})

function layout(value, key, startAngle, endAngle, innerRadius, outerRadius){
    var row = value.row;
    var col = value.col;

    var radius, angle;

    startAngle = startAngle + groupMargin;
    endAngle = endAngle - groupMargin;

//  TODO: change constants below to variables
    radiusInc = (outerRadius - innerRadius) /5;
    angleInc = (endAngle - startAngle)/15;

    radius = innerRadius + row * radiusInc;
    angle = (startAngle + (angleInc * col)) * (Math.PI/180);

    x = radius * Math.cos(angle);
    y = radius * Math.sin(angle);
    dataNodes.push({"x": x, "y": y});
    dataNodesMap.set(key, {"x": x, "y": y, "angle": angle, "radius": radius});
}

function linkLayout(d){
    source = d.s;
    target = d.t;

    sourceNode = data.get(source);
    targetNode = data.get(target);

    sourcePos = dataNodesMap.get(source);
    targetPos = dataNodesMap.get(target);

    if(sourceNode.row == targetNode.row)
    {
        sX = sourcePos.x;
        sY = sourcePos.y;

        cX = (sourcePos.radius+5)*Math.cos(sourcePos.angle);
        cY = (sourcePos.radius+5)*Math.sin(sourcePos.angle);

        sA = sourcePos.angle+1*(Math.PI/180);
        tX = (sourcePos.radius+5)*Math.cos(sA);
        tY = (sourcePos.radius+5)*Math.sin(sA);


        cX2 = (targetPos.radius+5)*Math.cos(targetPos.angle);
        cY2 = (targetPos.radius+5)*Math.sin(targetPos.angle);

        tA = targetPos.angle-1*(Math.PI/180);
        tX2 = (sourcePos.radius+5)*Math.cos(tA);
        tY2 = (sourcePos.radius+5)*Math.sin(tA);

        linkArc.push({"startAngle": sA, "endAngle": tA, "innerR": sourcePos.radius, "outerR":sourcePos.radius })

    }
    else{

        sX = sourcePos.x;
        sY = sourcePos.y;

        cX = (sourcePos.radius)*Math.cos(sourcePos.angle+1*(Math.PI/180));
        cY = (sourcePos.radius)*Math.sin(sourcePos.angle+1*(Math.PI/180));

        sA = sourcePos.angle+2*(Math.PI/180);
        tX = (sourcePos.radius+2)*Math.cos(sA);
        tY = (sourcePos.radius+2)*Math.sin(sA);


        cX2=(targetPos.radius)*Math.cos(targetPos.angle+1*(Math.PI/180));
        cY2=(targetPos.radius)*Math.sin(targetPos.angle+1*(Math.PI/180));

        tX2 = (targetPos.radius-2)*Math.cos(sA);
        tY2 = (targetPos.radius-2)*Math.sin(sA);

        linkLine.push({"source": {"x": tX, "y": tY},"target": {"x": tX2, "y": tY2}});

    }

    linkConn.push({"source": {"x": sourcePos.x, "y": sourcePos.y}, "control": {"x": cX, "y": cY}, "target": {"x": tX, "y": tY}});
    linkConn.push({"source": {"x": targetPos.x , "y": targetPos.y}, "control": {"x": cX2, "y": cY2}, "target": {"x": tX2, "y": tY2}});
    //access location of the source and target nodes from ...
    //use arc and/or bezier curve to make links
}

//---------display d3 objects--------------------------------
var d3Nodes = svg.selectAll("circle")
                .data(dataNodes)
                .enter()
                .append("circle")
                .attr("cx", function(value, key){return value.x})
                .attr("cy", function(value, key){return value.y})
                .attr("r", 2);

var d3LinkConn = svg.selectAll("path")
        .data(linkConn)
        .enter()
        .append("path")
        .attr("d", function(d){
            return "M" + d.source.x + "," + d.source.y +
                    "S" + d.control.x + "," + d.control.y +
                    " " + d.target.x + "," + d.target.y;
        })
        .attr("stroke", "red")
        .attr("stroke-width", 1)
        .attr("fill", "none")
        .attr("stroke-opacity",.4);

var d3LinkLine = svg.selectAll("line")
        .data(linkLine)
        .enter()
        .append("line")
        .attr("x1", function(d){return d.source.x})
        .attr("y1", function(d){return d.source.y})
        .attr("x2", function(d){return d.target.x})
        .attr("y2", function(d){return d.target.y})
        .attr("stroke", "red")
        .attr("fill", "none")
        .attr("stroke-opacity",.4)
        .attr("stroke-width", 1);


//TODO: Get rid of hacks
var arc = d3.svg.arc()
        .startAngle(function(d){return d.startAngle + (90 * (Math.PI/180));})
        .endAngle(function(d){return d.endAngle+ (90 * (Math.PI/180));})
        .innerRadius(function(d){return d.innerR+5;})
        .outerRadius(function(d){return d.outerR+5;});

    var d3Links = svg.selectAll("arcLink")
                    .data(linkArc)
                    .enter()
                    .append("path")
                    .attr("d", arc)
                    .attr("stroke", "red")
            .attr("stroke-width", 1)
            .attr("stroke-opacity",.4) ;

</script>
</body>